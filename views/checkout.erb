<!-- Checkout Page -->
<div class="container py-5">
    <div class="row">
        <div class="col-lg-8">
            <!-- Checkout Header -->
            <div class="d-flex align-items-center mb-4">
                <a href="/cart" class="btn btn-outline-secondary me-3">
                    <i class="fas fa-arrow-left"></i>
                </a>
                <h2 class="fw-bold mb-0">
                    <i class="fas fa-credit-card me-2"></i>
                    <%= custom_text('checkout_title', 'Checkout') %>
                </h2>
            </div>

            <!-- Checkout Steps -->
            <div class="card mb-4">
                <div class="card-body">
                    <div class="checkout-steps">
                        <div class="d-flex align-items-center">
                            <div class="step active">
                                <span class="step-number">1</span>
                                <span class="step-label"><%= custom_text('checkout_step_information', 'Information') %></span>
                            </div>
                            <div class="step-divider"></div>
                            <div class="step">
                                <span class="step-number">2</span>
                                <span class="step-label"><%= custom_text('checkout_step_payment', 'Payment') %></span>
                            </div>
                            <div class="step-divider"></div>
                            <div class="step">
                                <span class="step-number">3</span>
                                <span class="step-label"><%= custom_text('checkout_step_complete', 'Complete') %></span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Customer Information Form -->
            <div class="card mb-4" id="customer-info-section">
                <div class="card-header">
                    <h5 class="fw-bold mb-0">
                        <i class="fas fa-user me-2"></i>
                        <%= custom_text('checkout_customer_info', 'Customer Information') %>
                    </h5>
                </div>
                <div class="card-body">
                    <form id="customer-form">
                        <% if user_logged_in? %>
                            <!-- Logged-in user: show their info (read-only) -->
                            <div class="alert alert-info mb-3">
                                <i class="fas fa-info-circle me-2"></i>
                                You are logged in as <strong><%= current_user.display_name %></strong>
                            </div>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Full Name</label>
                                    <input type="text" class="form-control" value="<%= current_user.name || current_user.display_name %>" readonly autocomplete="off">
                                    <input type="hidden" id="customer-name" value="<%= current_user.name || current_user.display_name %>">
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label class="form-label">Email Address</label>
                                    <input type="email" class="form-control" value="<%= current_user.email %>" readonly autocomplete="off">
                                    <input type="hidden" id="customer-email" value="<%= current_user.email %>">
                                </div>
                            </div>
                        <% else %>
                            <!-- Guest user: show editable fields -->
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="customer-name" class="form-label">Full Name *</label>
                                    <input type="text" class="form-control" id="customer-name" required autocomplete="name">
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="customer-email" class="form-label">Email Address *</label>
                                    <input type="email" class="form-control" id="customer-email" required autocomplete="email">
                                </div>
                            </div>
                        <% end %>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="company-name" class="form-label">Company Name</label>
                                <input type="text" class="form-control" id="company-name" autocomplete="organization">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="phone-number" class="form-label">Phone Number</label>
                                <input type="tel" class="form-control" id="phone-number" autocomplete="tel">
                            </div>
                        </div>

                        <!-- Billing Address Section -->
                        <hr class="my-4">
                        <h6 class="fw-bold mb-3">
                            <i class="fas fa-map-marker-alt me-2"></i>
                            Billing Address
                        </h6>

                        <% if user_logged_in? %>
                            <!-- Address selection for logged-in users -->
                            <div id="address-selection-section">
                                <div class="mb-3">
                                    <label for="address-selector" class="form-label">Select Address</label>
                                    <select class="form-select" id="address-selector" onchange="handleAddressSelection()">
                                        <option value="">Choose an address...</option>
                                        <option value="new">+ Add New Address</option>
                                    </select>
                                </div>

                                <!-- Selected address preview -->
                                <div id="selected-address-preview" class="address-preview mb-3" style="display: none;">
                                    <div class="card">
                                        <div class="card-body">
                                            <div id="address-preview-content"></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        <% end %>

                        <!-- Address form (always shown for guests, shown when "new" selected for users) -->
                        <div id="address-form-section" <% if user_logged_in? %> style="display: none;"<% end %>>
                            <% if user_logged_in? %>
                                <div class="mb-3">
                                    <label for="address-name" class="form-label">Address Name *</label>
                                    <input type="text" class="form-control" id="address-name" placeholder="e.g., Home, Work, Billing" autocomplete="off">
                                    <small class="form-text text-muted">Give this address a name for easy selection later</small>
                                </div>
                            <% end %>

                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="billing-first-name" class="form-label">First Name *</label>
                                    <input type="text" class="form-control" id="billing-first-name" required autocomplete="given-name">
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="billing-last-name" class="form-label">Last Name *</label>
                                    <input type="text" class="form-control" id="billing-last-name" required autocomplete="family-name">
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-12 mb-3">
                                    <label for="billing-company" class="form-label">Company</label>
                                    <input type="text" class="form-control" id="billing-company" autocomplete="organization">
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-12 mb-3">
                                    <label for="address-line1" class="form-label">Address Line 1 *</label>
                                    <input type="text" class="form-control" id="address-line1" required autocomplete="address-line1">
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-12 mb-3">
                                    <label for="address-line2" class="form-label">Address Line 2</label>
                                    <input type="text" class="form-control" id="address-line2" autocomplete="address-line2">
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="city" class="form-label">City *</label>
                                    <input type="text" class="form-control" id="city" required autocomplete="address-level2">
                                </div>
                                <div class="col-md-3 mb-3">
                                    <label for="state" class="form-label">State/Province *</label>
                                    <input type="text" class="form-control" id="state" required autocomplete="address-level1">
                                </div>
                                <div class="col-md-3 mb-3">
                                    <label for="postal-code" class="form-label">ZIP/Postal Code *</label>
                                    <input type="text" class="form-control" id="postal-code" required autocomplete="postal-code">
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="country" class="form-label">Country *</label>
                                    <select class="form-select" id="country" required autocomplete="country">
                                        <option value="">Select Country</option>
                                        <option value="CA">Canada</option>
                                        <option value="US" selected>United States</option>
                                        <option value="GB">United Kingdom</option>
                                        <option value="AU">Australia</option>
                                        <option value="DE">Germany</option>
                                        <option value="FR">France</option>
                                        <option value="IT">Italy</option>
                                        <option value="ES">Spain</option>
                                        <option value="NL">Netherlands</option>
                                        <option value="BE">Belgium</option>
                                        <option value="CH">Switzerland</option>
                                        <option value="AT">Austria</option>
                                        <option value="SE">Sweden</option>
                                        <option value="NO">Norway</option>
                                        <option value="DK">Denmark</option>
                                        <option value="FI">Finland</option>
                                        <option value="IE">Ireland</option>
                                        <option value="PT">Portugal</option>
                                        <option value="PL">Poland</option>
                                        <option value="CZ">Czech Republic</option>
                                        <option value="HU">Hungary</option>
                                        <option value="SK">Slovakia</option>
                                        <option value="SI">Slovenia</option>
                                        <option value="HR">Croatia</option>
                                        <option value="GR">Greece</option>
                                        <option value="BG">Bulgaria</option>
                                        <option value="RO">Romania</option>
                                        <option value="EE">Estonia</option>
                                        <option value="LV">Latvia</option>
                                        <option value="LT">Lithuania</option>
                                        <option value="LU">Luxembourg</option>
                                        <option value="MT">Malta</option>
                                        <option value="CY">Cyprus</option>
                                        <option value="JP">Japan</option>
                                        <option value="KR">Korea, Republic of</option>
                                        <option value="SG">Singapore</option>
                                        <option value="HK">Hong Kong</option>
                                        <option value="TW">Taiwan</option>
                                        <option value="MY">Malaysia</option>
                                        <option value="TH">Thailand</option>
                                        <option value="PH">Philippines</option>
                                        <option value="ID">Indonesia</option>
                                        <option value="VN">Viet Nam</option>
                                        <option value="IN">India</option>
                                        <option value="CN">China</option>
                                        <option value="BR">Brazil</option>
                                        <option value="MX">Mexico</option>
                                        <option value="AR">Argentina</option>
                                        <option value="CL">Chile</option>
                                        <option value="CO">Colombia</option>
                                        <option value="PE">Peru</option>
                                        <option value="ZA">South Africa</option>
                                        <option value="NG">Nigeria</option>
                                        <option value="EG">Egypt</option>
                                        <option value="MA">Morocco</option>
                                        <option value="KE">Kenya</option>
                                        <option value="GH">Ghana</option>
                                        <option value="IL">Israel</option>
                                        <option value="AE">United Arab Emirates</option>
                                        <option value="SA">Saudi Arabia</option>
                                        <option value="TR">Turkey</option>
                                        <option value="RU">Russian Federation</option>
                                        <option value="UA">Ukraine</option>
                                        <option value="BY">Belarus</option>
                                        <option value="KZ">Kazakhstan</option>
                                        <option value="UZ">Uzbekistan</option>
                                        <option value="NZ">New Zealand</option>
                                    </select>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="billing-phone" class="form-label">Phone Number</label>
                                    <input type="tel" class="form-control" id="billing-phone" autocomplete="tel">
                                </div>
                            </div>

                            <% if user_logged_in? %>
                                <div class="mb-3">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="save-address" checked>
                                        <label class="form-check-label" for="save-address">
                                            Save this address for future use
                                        </label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="set-default-address">
                                        <label class="form-check-label" for="set-default-address">
                                            Set as default billing address
                                        </label>
                                    </div>
                                </div>
                            <% end %>
                        </div>

                        <% unless user_logged_in? %>
                            <div class="mb-3">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="newsletter-signup">
                                    <label class="form-check-label" for="newsletter-signup">
                                        Subscribe to newsletter for product updates
                                    </label>
                                </div>
                            </div>
                        <% end %>

                        <div class="d-flex justify-content-end">
                            <button type="button" class="btn btn-primary" id="continue-btn" onclick="proceedToNext()">
                                <span id="continue-text">Continue to Payment</span>
                                <i class="fas fa-arrow-right ms-2"></i>
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Payment Method Selection -->
            <div class="card mb-4" id="payment-method-section" style="display: none;">
                <div class="card-header">
                    <h5 class="fw-bold mb-0">
                        <i class="fas fa-credit-card me-2"></i>
                        Payment Method
                    </h5>
                </div>
                <div class="card-body">
                    <div class="payment-methods mb-4">
                        <% if stripe_enabled? %>
                        <div class="payment-method-option">
                            <input type="radio" class="form-check-input" name="payment-method" id="stripe-payment" value="stripe" checked>
                            <label class="form-check-label w-100" for="stripe-payment">
                                <div class="payment-method-card">
                                    <div class="d-flex align-items-center">
                                        <i class="fab fa-stripe text-primary me-3" style="font-size: 2rem;"></i>
                                        <div>
                                            <div class="fw-bold">Credit/Debit Card</div>
                                            <small class="text-muted">Visa, Mastercard, American Express</small>
                                        </div>
                                        <div class="ms-auto">
                                            <i class="fas fa-shield-alt text-success"></i>
                                        </div>
                                    </div>
                                </div>
                            </label>
                        </div>
                        <% end %>

                        <% if paypal_enabled? %>
                        <div class="payment-method-option">
                            <input type="radio" class="form-check-input" name="payment-method" id="paypal-payment" value="paypal">
                            <label class="form-check-label w-100" for="paypal-payment">
                                <div class="payment-method-card">
                                    <div class="d-flex align-items-center">
                                        <i class="fab fa-paypal text-info me-3" style="font-size: 2rem;"></i>
                                        <div>
                                            <div class="fw-bold">PayPal</div>
                                            <small class="text-muted">Pay with your PayPal account</small>
                                        </div>
                                        <div class="ms-auto">
                                            <i class="fas fa-shield-alt text-success"></i>
                                        </div>
                                    </div>
                                </div>
                            </label>
                        </div>
                        <% end %>
                    </div>

                    <!-- Stripe Card Element -->
                    <div id="stripe-card-section" class="payment-form-section">
                        <div class="mb-3">
                            <label class="form-label">Card Information</label>
                            <div id="card-element" class="form-control" style="padding: 12px;">
                                <!-- Stripe Elements will create form elements here -->
                            </div>
                            <div id="card-errors" class="text-danger mt-2"></div>
                        </div>
                    </div>

                    <!-- PayPal Section -->
                    <div id="paypal-section" class="payment-form-section" style="display: none;">
                        <div id="paypal-button-container"></div>
                    </div>

                    <div class="d-flex justify-content-between">
                        <button type="button" class="btn btn-outline-secondary" onclick="backToCustomerInfo()">
                            <i class="fas fa-arrow-left me-2"></i>
                            Back
                        </button>
                        <button type="button" class="btn btn-primary" id="complete-payment-btn" onclick="completePayment()">
                            <i class="fas fa-lock me-2"></i>
                            Complete Payment
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Order Summary Sidebar -->
        <div class="col-lg-4">
            <div class="card sticky-top" style="top: 100px;">
                <div class="card-header">
                    <h5 class="fw-bold mb-0">
                        <i class="fas fa-receipt me-2"></i>
                        Order Summary
                    </h5>
                </div>
                <div class="card-body">
                    <div id="checkout-order-summary">
                        <!-- Order summary will be populated via JavaScript -->
                    </div>

                    <!-- Security Information -->
                    <hr>
                    <div class="security-info">
                        <h6 class="fw-bold mb-3">
                            <i class="fas fa-shield-alt text-success me-2"></i>
                            Secure Checkout
                        </h6>
                        <div class="small text-muted">
                            <div class="d-flex align-items-center mb-2">
                                <i class="fas fa-lock text-success me-2"></i>
                                <span>SSL encrypted payment</span>
                            </div>
                            <div class="d-flex align-items-center mb-2">
                                <i class="fas fa-certificate text-success me-2"></i>
                                <span>PCI DSS compliant</span>
                            </div>
                            <div class="d-flex align-items-center">
                                <i class="fas fa-clock text-success me-2"></i>
                                <span>Instant license delivery</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
/* Checkout Steps Styling */
.checkout-steps {
    padding: 1rem 0;
}

.checkout-steps .d-flex {
    max-width: 400px;
    margin: 0 auto;
}

.step {
    display: flex;
    flex-direction: column;
    align-items: center;
    flex: 1;
    opacity: 0.5;
    transition: opacity 0.3s ease;
}

.step.active {
    opacity: 1;
}

.step-number {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background: var(--surface-tertiary);
    border: 2px solid var(--border-default);
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: bold;
    margin-bottom: 0.5rem;
    transition: all 0.3s ease;
}

.step.active .step-number {
    background: var(--accent-primary);
    border-color: var(--accent-primary);
    color: white;
}

.step-label {
    font-size: 0.875rem;
    font-weight: 500;
    text-align: center;
}

.step-divider {
    height: 2px;
    background: var(--border-default);
    flex: 1;
    margin: 0 1rem;
    margin-top: 20px;
    transition: background-color 0.3s ease;
}

/* Payment Method Styling */
.payment-method-option {
    margin-bottom: 1rem;
}

.payment-method-card {
    border: 2px solid var(--border-default);
    border-radius: 8px;
    padding: 1rem;
    transition: all 0.3s ease;
    cursor: pointer;
}

.payment-method-option input[type="radio"]:checked + label .payment-method-card {
    border-color: var(--accent-primary);
    background: rgba(35, 134, 54, 0.1);
}

.payment-method-card:hover {
    border-color: var(--accent-primary);
}

.payment-form-section {
    margin-top: 1rem;
    padding: 1rem;
    border: 1px solid var(--border-default);
    border-radius: 8px;
    background: var(--surface-tertiary);
}

/* Stripe Elements Styling */
#card-element {
    background: var(--surface-secondary);
    border: 1px solid var(--border-default);
    min-height: 50px;
}

.StripeElement {
    background-color: transparent;
    padding: 10px 12px;
    border: none;
}

.StripeElement--focus {
    border-color: var(--accent-primary);
    box-shadow: 0 0 0 0.2rem rgba(35, 134, 54, 0.25);
}

.StripeElement--invalid {
    border-color: var(--bs-danger);
}

/* Loading state */
.btn-loading {
    position: relative;
    color: transparent !important;
}

.btn-loading::after {
    content: '';
    position: absolute;
    width: 20px;
    height: 20px;
    top: 50%;
    left: 50%;
    margin-left: -10px;
    margin-top: -10px;
    border: 2px solid #ffffff;
    border-radius: 50%;
    border-top-color: transparent;
    animation: spin 1s ease-in-out infinite;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}
</style>

<script>
// Checkout functionality
class CheckoutManager {
    constructor() {
        this.cartItems = JSON.parse(sessionStorage.getItem('checkout_cart') || '[]');
        this.products = {};
        this.stripe = null;
        this.cardElement = null;
        this.currentStep = 1;

        this.loadProducts();
        this.initializePaymentMethods();
        this.renderOrderSummary();

        // Setup payment method change handlers
        document.querySelectorAll('input[name="payment-method"]').forEach(radio => {
            radio.addEventListener('change', () => this.handlePaymentMethodChange());
        });
    }

    async loadProducts() {
        try {
            const response = await fetch('/api/products');
            if (response.ok) {
                const data = await response.json();
                this.products = data.reduce((acc, product) => {
                    acc[product.id] = product;
                    return acc;
                }, {});
                this.renderOrderSummary();
            }
        } catch (error) {
            console.error('Failed to load products:', error);
        }
    }

    initializePaymentMethods() {
        <% if stripe_enabled? %>
        // Initialize Stripe
        this.stripe = Stripe('<%= ENV['STRIPE_PUBLISHABLE_KEY'] %>');
        const elements = this.stripe.elements({
            appearance: {
                theme: 'night',
                variables: {
                    colorPrimary: '#238636',
                    colorBackground: '#21262d',
                    colorText: '#e6edf3',
                    colorDanger: '#da3633',
                    borderRadius: '8px'
                }
            }
        });

        this.cardElement = elements.create('card', {
            hidePostalCode: true
        });
        this.cardElement.mount('#card-element');

        this.cardElement.on('change', (event) => {
            const displayError = document.getElementById('card-errors');
            if (event.error) {
                displayError.textContent = event.error.message;
            } else {
                displayError.textContent = '';
            }
        });
        <% end %>

        <% if paypal_enabled? %>
        // Initialize PayPal (will be loaded when PayPal method is selected)
        <% end %>
    }

    handlePaymentMethodChange() {
        const selectedMethod = document.querySelector('input[name="payment-method"]:checked').value;

        // Hide all payment sections
        document.querySelectorAll('.payment-form-section').forEach(section => {
            section.style.display = 'none';
        });

        // Show selected payment section
        if (selectedMethod === 'stripe') {
            document.getElementById('stripe-card-section').style.display = 'block';
        } else if (selectedMethod === 'paypal') {
            document.getElementById('paypal-section').style.display = 'block';
            this.initializePayPal();
        }
    }

    <% if paypal_enabled? %>
    initializePayPal() {
        // Clear existing PayPal buttons
        document.getElementById('paypal-button-container').innerHTML = '';

        paypal.Buttons({
            createOrder: (data, actions) => {
                return this.createPayPalOrder();
            },
            onApprove: (data, actions) => {
                return this.handlePayPalApproval(data.orderID);
            },
            onError: (err) => {
                console.error('PayPal error:', err);
                this.showNotification('PayPal payment failed. Please try again.', 'danger');
            }
        }).render('#paypal-button-container');
    }
    <% end %>

    renderOrderSummary() {
        const container = document.getElementById('checkout-order-summary');

        if (this.cartItems.length === 0) {
            container.innerHTML = '<p class="text-muted">No items to checkout</p>';
            return;
        }

        let subtotal = 0;
        let setupFees = 0;
        const itemsHtml = this.cartItems.map(item => {
            const product = this.products[item.productId];
            if (!product) return '';

            const itemTotal = parseFloat(product.price) * item.quantity;
            const itemSetupFee = parseFloat(product.setup_fee || 0) * item.quantity;

            subtotal += itemTotal;
            setupFees += itemSetupFee;

            return `
                <div class="d-flex justify-content-between align-items-start mb-3">
                    <div class="flex-grow-1">
                        <div class="fw-bold">${product.name}</div>
                        <small class="text-muted">Qty: ${item.quantity}</small>
                        ${product.license_type === 'subscription' ? '<small class="d-block text-info">Monthly billing</small>' : ''}
                    </div>
                    <div class="text-end">
                        <div>${window.SourceLicense.formatCurrency(itemTotal)}</div>
                        ${itemSetupFee > 0 ? `<small class="text-muted">+ ${window.SourceLicense.formatCurrency(itemSetupFee)} setup</small>` : ''}
                    </div>
                </div>
            `;
        }).join('');

        const total = subtotal + setupFees;

        container.innerHTML = `
            ${itemsHtml}
            <hr>
            <div class="d-flex justify-content-between mb-2">
                <span>Subtotal:</span>
                <span>${window.SourceLicense.formatCurrency(subtotal)}</span>
            </div>
            ${setupFees > 0 ? `
                <div class="d-flex justify-content-between mb-2">
                    <span>Setup Fees:</span>
                    <span>${window.SourceLicense.formatCurrency(setupFees)}</span>
                </div>
            ` : ''}
            <hr>
            <div class="d-flex justify-content-between fw-bold h5">
                <span>Total:</span>
                <span class="text-success">${window.SourceLicense.formatCurrency(total)}</span>
            </div>
        `;

        // Update button text based on total
        this.updateContinueButton(total);
    }

    updateContinueButton(total) {
        const continueText = document.getElementById('continue-text');
        const continueBtn = document.getElementById('continue-btn');

        if (total === 0) {
            continueText.textContent = 'Complete Free Order';
            continueBtn.className = continueBtn.className.replace('btn-primary', 'btn-success');
        } else {
            continueText.textContent = 'Continue to Payment';
            continueBtn.className = continueBtn.className.replace('btn-success', 'btn-primary');
        }
    }

    calculateTotal() {
        let total = 0;
        this.cartItems.forEach(item => {
            const product = this.products[item.productId];
            if (product) {
                total += (parseFloat(product.price) + parseFloat(product.setup_fee || 0)) * item.quantity;
            }
        });
        return total;
    }

    showNotification(message, type = 'info') {
        const notification = document.createElement('div');
        notification.className = `alert alert-${type} flash-message position-fixed`;
        notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; max-width: 300px;';
        notification.textContent = message;

        document.body.appendChild(notification);

        setTimeout(() => {
            notification.style.transition = 'opacity 0.5s ease';
            notification.style.opacity = '0';
            setTimeout(() => notification.remove(), 500);
        }, 3000);
    }

    async createOrder() {
        const customerData = {
            name: document.getElementById('customer-name').value,
            email: document.getElementById('customer-email').value,
            company: document.getElementById('company-name').value,
            phone: document.getElementById('phone-number').value
        };

        // Get selected payment method
        const selectedPaymentMethod = document.querySelector('input[name="payment-method"]:checked')?.value || 'stripe';

        const orderData = {
            customer: customerData,
            items: this.cartItems,
            amount: this.calculateTotal(),
            currency: 'USD',
            payment_method: selectedPaymentMethod
        };

        try {
            const response = await fetch('/api/orders', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(orderData)
            });

            if (response.ok) {
                return await response.json();
            } else {
                throw new Error('Failed to create order');
            }
        } catch (error) {
            console.error('Error creating order:', error);
            throw error;
        }
    }

    async createPayPalOrder() {
        try {
            const order = await this.createOrder();
            return order.paypal_order_id;
        } catch (error) {
            console.error('Failed to create PayPal order:', error);
            this.showNotification('Failed to create order. Please try again.', 'danger');
        }
    }

    async handlePayPalApproval(orderID) {
        try {
            const response = await fetch('/api/payment/paypal/capture', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ order_id: orderID })
            });

            if (response.ok) {
                const result = await response.json();
                if (result.success) {
                    this.handlePaymentSuccess(result);
                }
            }
        } catch (error) {
            console.error('PayPal capture error:', error);
            this.showNotification('Payment processing failed. Please try again.', 'danger');
        }
    }

    async handlePaymentSuccess(result) {
        // Clear cart
        localStorage.removeItem('cart');
        sessionStorage.removeItem('checkout_cart');

        // Wait for webhook processing to complete before redirecting
        await this.waitForOrderCompletion(result.order_id);

        // Redirect to success page
        window.location.href = `/success?order_id=${result.order_id}`;
    }

    // Wait for webhooks to complete order processing and license generation
    async waitForOrderCompletion(orderId, maxAttempts = 30) {
        this.showNotification('Processing payment and generating licenses...', 'info');

        for (let attempt = 1; attempt <= maxAttempts; attempt++) {
            try {
                const response = await fetch(`/api/orders/${orderId}`);
                if (response.ok) {
                    const orderData = await response.json();

                    // Check if order is completed AND has licenses
                    if (orderData.status === 'completed' && orderData.license_keys && orderData.license_keys.length > 0) {
                        this.showNotification('Payment processed successfully! Redirecting...', 'success');
                        return; // Order is complete with licenses
                    }

                    // If order is completed but no licenses yet, continue waiting
                    if (orderData.status === 'completed') {
                        console.log(`Attempt ${attempt}: Order completed, waiting for license generation...`);
                    } else {
                        console.log(`Attempt ${attempt}: Order status: ${orderData.status}, waiting...`);
                    }
                } else {
                    console.log(`Attempt ${attempt}: Failed to fetch order status`);
                }
            } catch (error) {
                console.log(`Attempt ${attempt}: Error checking order status:`, error);
            }

            // Wait 1 second before next attempt (exponential backoff for later attempts)
            const delay = attempt < 10 ? 1000 : Math.min(2000, 1000 * Math.pow(1.2, attempt - 10));
            await new Promise(resolve => setTimeout(resolve, delay));
        }

        // If we've reached max attempts, show warning but still redirect
        this.showNotification('Payment processed, but license generation is taking longer than expected. Redirecting...', 'warning');
        console.warn('Webhook processing took longer than expected, proceeding to success page');
    }
}

// Initialize checkout
let checkout;
document.addEventListener('DOMContentLoaded', function() {
    checkout = new CheckoutManager();
    <% if user_logged_in? %>
        loadUserAddresses();
    <% end %>
});

<% if user_logged_in? %>
// Address management functions for logged-in users
async function loadUserAddresses() {
    try {
        const response = await fetch('/api/user/addresses');
        if (response.ok) {
            const addresses = await response.json();
            populateAddressSelector(addresses);
        }
    } catch (error) {
        console.error('Failed to load addresses:', error);
    }
}

function populateAddressSelector(addresses) {
    const selector = document.getElementById('address-selector');

    // Clear existing options (except first two)
    while (selector.children.length > 2) {
        selector.removeChild(selector.lastChild);
    }

    // Add user addresses
    addresses.forEach(address => {
        const option = document.createElement('option');
        option.value = address.id;
        option.textContent = `${address.name} - ${address.single_line_address}`;
        if (address.is_default) {
            option.textContent += ' (Default)';
        }
        selector.appendChild(option);
    });

    // Auto-select default address if available
    const defaultAddress = addresses.find(addr => addr.is_default);
    if (defaultAddress) {
        selector.value = defaultAddress.id;
        handleAddressSelection();
    }
}

function handleAddressSelection() {
    const selector = document.getElementById('address-selector');
    const selectedValue = selector.value;

    const addressFormSection = document.getElementById('address-form-section');
    const addressPreview = document.getElementById('selected-address-preview');

    if (selectedValue === 'new') {
        // Show new address form
        addressFormSection.style.display = 'block';
        addressPreview.style.display = 'none';
        clearAddressForm();
    } else if (selectedValue === '') {
        // No selection
        addressFormSection.style.display = 'none';
        addressPreview.style.display = 'none';
    } else {
        // Load selected address
        loadSelectedAddress(selectedValue);
        addressFormSection.style.display = 'none';
        addressPreview.style.display = 'block';
    }
}

async function loadSelectedAddress(addressId) {
    try {
        const response = await fetch(`/api/user/addresses/${addressId}`);
        if (response.ok) {
            const address = await response.json();
            displayAddressPreview(address);
            // Store selected address ID for checkout
            window.selectedAddressId = addressId;
        }
    } catch (error) {
        console.error('Failed to load address:', error);
    }
}

function displayAddressPreview(address) {
    const previewContent = document.getElementById('address-preview-content');
    previewContent.innerHTML = `
        <div class="d-flex justify-content-between align-items-start">
            <div>
                <h6 class="fw-bold mb-1">${address.name}</h6>
                <div class="text-muted">
                    <div><strong>${address.full_name}</strong></div>
                    ${address.company ? `<div>${address.company}</div>` : ''}
                    <div>${address.address_line_1}</div>
                    ${address.address_line_2 ? `<div>${address.address_line_2}</div>` : ''}
                    <div>${address.city}, ${address.state_province} ${address.postal_code}</div>
                    <div>${address.country}</div>
                    ${address.phone ? `<div>${address.phone}</div>` : ''}
                </div>
            </div>
            <button type="button" class="btn btn-sm btn-outline-primary" onclick="editSelectedAddress()">
                <i class="fas fa-edit"></i> Edit
            </button>
        </div>
    `;
}

function editSelectedAddress() {
    const selector = document.getElementById('address-selector');
    selector.value = 'new';
    handleAddressSelection();

    // If we have a selected address, populate the form with its data
    if (window.selectedAddressId) {
        populateAddressForm(window.selectedAddressId);
    }
}

async function populateAddressForm(addressId) {
    try {
        const response = await fetch(`/api/user/addresses/${addressId}`);
        if (response.ok) {
            const address = await response.json();

            document.getElementById('address-name').value = address.name;
            document.getElementById('billing-first-name').value = address.first_name;
            document.getElementById('billing-last-name').value = address.last_name;
            document.getElementById('billing-company').value = address.company || '';
            document.getElementById('address-line1').value = address.address_line_1;
            document.getElementById('address-line2').value = address.address_line_2 || '';
            document.getElementById('city').value = address.city;
            document.getElementById('state').value = address.state_province;
            document.getElementById('postal-code').value = address.postal_code;
            document.getElementById('country').value = address.country;
            document.getElementById('billing-phone').value = address.phone || '';
            document.getElementById('set-default-address').checked = address.is_default;
        }
    } catch (error) {
        console.error('Failed to populate address form:', error);
    }
}

function clearAddressForm() {
    document.getElementById('address-name').value = '';
    document.getElementById('billing-first-name').value = '';
    document.getElementById('billing-last-name').value = '';
    document.getElementById('billing-company').value = '';
    document.getElementById('address-line1').value = '';
    document.getElementById('address-line2').value = '';
    document.getElementById('city').value = '';
    document.getElementById('state').value = '';
    document.getElementById('postal-code').value = '';
    document.getElementById('country').value = 'US';
    document.getElementById('billing-phone').value = '';
    document.getElementById('save-address').checked = true;
    document.getElementById('set-default-address').checked = false;
}
<% end %>

// Step navigation functions
async function proceedToNext() {
    const form = document.getElementById('customer-form');
    if (!form.checkValidity()) {
        form.reportValidity();
        return;
    }

    // Store billing address information for payment processing
    await storeBillingAddressInfo();

    // Check if order total is free
    const total = checkout.calculateTotal();

    if (total === 0) {
        // Free order - skip payment and complete directly
        completeFreeOrder();
    } else {
        // Paid order - proceed to payment
        proceedToPayment();
    }
}

// Store billing address information for use in payment processing
async function storeBillingAddressInfo() {
    let billingAddress = {};

    <% if user_logged_in? %>
        // For logged-in users, check if they selected an existing address or are creating new
        const selectedAddressId = document.getElementById('address-selector').value;

        if (selectedAddressId && selectedAddressId !== 'new' && selectedAddressId !== '') {
            // Use existing selected address
            if (window.selectedAddressId) {
                try {
                    const response = await fetch(`/api/user/addresses/${window.selectedAddressId}`);
                    if (response.ok) {
                        const address = await response.json();
                        billingAddress = {
                            name: `${address.first_name} ${address.last_name}`,
                            email: document.getElementById('customer-email').value,
                            line1: address.address_line_1,
                            line2: address.address_line_2,
                            city: address.city,
                            state: address.state_province,
                            postal_code: address.postal_code,
                            country: address.country
                        };
                    }
                } catch (error) {
                    console.error('Failed to load selected address:', error);
                }
            }
        } else if (selectedAddressId === 'new') {
            // Creating new address - get from form
            billingAddress = getBillingAddressFromForm();

            // Save the new address if the user wants to
            if (document.getElementById('save-address').checked) {
                await saveNewBillingAddress();
            }
        } else {
            // No address selected - get from form
            billingAddress = getBillingAddressFromForm();
        }
    <% else %>
        // For guest users, always get from form
        billingAddress = getBillingAddressFromForm();
    <% end %>

    // Store globally for payment processing
    window.storedBillingAddress = billingAddress;
}

function getBillingAddressFromForm() {
    return {
        name: document.getElementById('customer-name').value,
        email: document.getElementById('customer-email').value,
        line1: document.getElementById('address-line1').value,
        line2: document.getElementById('address-line2').value || null,
        city: document.getElementById('city').value,
        state: document.getElementById('state').value,
        postal_code: document.getElementById('postal-code').value,
        country: document.getElementById('country').value
    };
}

<% if user_logged_in? %>
async function saveNewBillingAddress() {
    const addressData = {
        name: document.getElementById('address-name').value || 'Billing Address',
        first_name: document.getElementById('billing-first-name').value,
        last_name: document.getElementById('billing-last-name').value,
        company: document.getElementById('billing-company').value,
        address_line_1: document.getElementById('address-line1').value,
        address_line_2: document.getElementById('address-line2').value,
        city: document.getElementById('city').value,
        state_province: document.getElementById('state').value,
        postal_code: document.getElementById('postal-code').value,
        country: document.getElementById('country').value,
        phone: document.getElementById('billing-phone').value,
        is_default: document.getElementById('set-default-address').checked
    };

    try {
        const response = await fetch('/api/user/addresses', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(addressData)
        });

        if (response.ok) {
            const newAddress = await response.json();
            console.log('New address saved:', newAddress);
            // Optionally reload the address selector
            loadUserAddresses();
        } else {
            console.error('Failed to save address');
        }
    } catch (error) {
        console.error('Error saving address:', error);
    }
}
<% end %>

function proceedToPayment() {
    // Hide customer info, show payment
    document.getElementById('customer-info-section').style.display = 'none';
    document.getElementById('payment-method-section').style.display = 'block';

    // Update step indicator
    document.querySelectorAll('.step')[1].classList.add('active');

    // Show default payment method
    checkout.handlePaymentMethodChange();
}

async function completeFreeOrder() {
    const continueBtn = document.getElementById('continue-btn');
    continueBtn.classList.add('btn-loading');
    continueBtn.disabled = true;

    try {
        // Create the order for free products
        const customerData = {
            name: document.getElementById('customer-name').value,
            email: document.getElementById('customer-email').value,
            company: document.getElementById('company-name').value,
            phone: document.getElementById('phone-number').value
        };

        const orderData = {
            customer: customerData,
            items: checkout.cartItems,
            amount: 0,
            currency: 'USD',
            payment_method: 'free'
        };

        const response = await fetch('/api/orders/free', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(orderData)
        });

        if (response.ok) {
            const result = await response.json();
            checkout.handlePaymentSuccess(result);
        } else {
            throw new Error('Failed to process free order');
        }

    } catch (error) {
        console.error('Free order error:', error);
        checkout.showNotification('Failed to process order. Please try again.', 'danger');
    } finally {
        continueBtn.classList.remove('btn-loading');
        continueBtn.disabled = false;
    }
}

function backToCustomerInfo() {
    document.getElementById('payment-method-section').style.display = 'none';
    document.getElementById('customer-info-section').style.display = 'block';

    // Update step indicator
    document.querySelectorAll('.step')[1].classList.remove('active');
}

async function completePayment() {
    const selectedMethod = document.querySelector('input[name="payment-method"]:checked').value;
    const paymentBtn = document.getElementById('complete-payment-btn');

    paymentBtn.classList.add('btn-loading');
    paymentBtn.disabled = true;

    try {
        if (selectedMethod === 'stripe') {
            await processStripePayment();
        }
        // PayPal is handled by its own button
    } catch (error) {
        console.error('Payment error:', error);
        checkout.showNotification('Payment failed. Please try again.', 'danger');
    } finally {
        paymentBtn.classList.remove('btn-loading');
        paymentBtn.disabled = false;
    }
}

<% if stripe_enabled? %>
async function processStripePayment() {
    try {
        // Use stored billing address from the customer information step
        const storedAddress = window.storedBillingAddress;

        if (!storedAddress) {
            throw new Error('Billing address information is missing. Please go back and fill out your address.');
        }

        // Create order first
        const order = await checkout.createOrder();

        // Confirm payment with Stripe using stored billing address
        const {error, paymentIntent} = await checkout.stripe.confirmCardPayment(
            order.client_secret,
            {
                payment_method: {
                    card: checkout.cardElement,
                    billing_details: {
                        name: storedAddress.name,
                        email: storedAddress.email,
                        address: {
                            line1: storedAddress.line1,
                            line2: storedAddress.line2,
                            city: storedAddress.city,
                            state: storedAddress.state,
                            postal_code: storedAddress.postal_code,
                            country: storedAddress.country
                        }
                    }
                }
            }
        );

        if (error) {
            throw new Error(error.message);
        } else if (paymentIntent.status === 'succeeded') {
            checkout.handlePaymentSuccess({
                order_id: order.order_id,
                payment_intent_id: paymentIntent.id
            });
        }
    } catch (error) {
        throw error;
    }
}
<% end %>

// Setup products data from server-side
window.checkoutProductsData = <%= @products ? @products.map(&:values).to_json : '[]' %>;

// Override fetch for API endpoints
const originalFetch = window.fetch;
window.fetch = function(url, options) {
    if (url === '/api/products') {
        return Promise.resolve({
            ok: true,
            json: () => Promise.resolve(window.checkoutProductsData)
        });
    }
    // Let all other API calls (orders, etc.) go through to the real backend
    return originalFetch.apply(this, arguments);
};
</script>
