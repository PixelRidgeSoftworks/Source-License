<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <!-- Header -->
            <div class="text-center mb-5">
                <i class="fas fa-key text-primary mb-3" style="font-size: 4rem;"></i>
                <h1 class="h2 fw-bold mb-3">License Lookup</h1>
                <p class="lead text-muted">
                    Enter your license key or email address to view your licenses,
                    download software, and manage activations.
                </p>
            </div>

            <!-- Search Form -->
            <div class="card card-modern mb-4">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-search me-2"></i>
                        Find Your License
                    </h5>
                </div>
                <div class="card-body">
                    <form id="licenseSearchForm">
                        <div class="row g-3">
                            <div class="col-md-8">
                                <div class="form-floating">
                                    <input type="text"
                                           class="form-control"
                                           id="searchQuery"
                                           name="query"
                                           placeholder="XXXX-XXXX-XXXX-XXXX or email@example.com"
                                           required autocomplete="off">
                                    <label for="searchQuery">
                                        <i class="fas fa-key me-2"></i>
                                        License Key or Email Address
                                    </label>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <button type="submit" class="btn btn-primary h-100 w-100">
                                    <i class="fas fa-search me-2"></i>
                                    Search
                                </button>
                            </div>
                        </div>

                        <div class="mt-3">
                            <small class="text-muted">
                                <i class="fas fa-info-circle me-1"></i>
                                Enter either your license key (format: XXXX-XXXX-XXXX-XXXX) or
                                the email address used for purchase.
                            </small>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Results Container -->
            <div id="searchResults" class="d-none">
                <!-- Results will be loaded here via JavaScript -->
            </div>

            <!-- Help Section -->
            <div class="row g-4">
                <!-- Quick Validation -->
                <div class="col-md-6">
                    <div class="card card-modern h-100">
                        <div class="card-body text-center">
                            <i class="fas fa-shield-alt text-success mb-3" style="font-size: 2.5rem;"></i>
                            <h5 class="fw-bold">Quick Validation</h5>
                            <p class="text-muted mb-3">
                                Instantly check if your license is valid and see activation details.
                            </p>
                            <button class="btn btn-outline-success" onclick="showValidationModal()">
                                <i class="fas fa-check-circle me-2"></i>
                                Validate License
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Support -->
                <div class="col-md-6">
                    <div class="card card-modern h-100">
                        <div class="card-body text-center">
                            <i class="fas fa-life-ring text-info mb-3" style="font-size: 2.5rem;"></i>
                            <h5 class="fw-bold">Need Help?</h5>
                            <p class="text-muted mb-3">
                                Can't find your license? Our support team is here to help.
                            </p>
                            <a href="mailto:<%= ENV['SUPPORT_EMAIL'] || 'support@example.com' %>"
                               class="btn btn-outline-info">
                                <i class="fas fa-envelope me-2"></i>
                                Contact Support
                            </a>
                        </div>
                    </div>
                </div>
            </div>

            <!-- FAQ Section -->
            <div class="mt-5">
                <h3 class="h4 fw-bold mb-4 text-center">Frequently Asked Questions</h3>

                <div class="accordion" id="faqAccordion">
                    <!-- FAQ 1 -->
                    <div class="accordion-item">
                        <h2 class="accordion-header" id="faq1">
                            <button class="accordion-button collapsed" type="button"
                                    data-bs-toggle="collapse" data-bs-target="#collapse1">
                                <i class="fas fa-question-circle me-2"></i>
                                Where can I find my license key?
                            </button>
                        </h2>
                        <div id="collapse1" class="accordion-collapse collapse" data-bs-parent="#faqAccordion">
                            <div class="accordion-body">
                                Your license key was sent to your email address immediately after purchase.
                                Check your inbox and spam folder for an email from us. The license key
                                format is XXXX-XXXX-XXXX-XXXX.
                            </div>
                        </div>
                    </div>

                    <!-- FAQ 2 -->
                    <div class="accordion-item">
                        <h2 class="accordion-header" id="faq2">
                            <button class="accordion-button collapsed" type="button"
                                    data-bs-toggle="collapse" data-bs-target="#collapse2">
                                <i class="fas fa-download me-2"></i>
                                How do I download my software?
                            </button>
                        </h2>
                        <div id="collapse2" class="accordion-collapse collapse" data-bs-parent="#faqAccordion">
                            <div class="accordion-body">
                                After finding your license above, click on the "Download" button next to your
                                product. You'll need an active, valid license to access downloads.
                            </div>
                        </div>
                    </div>

                    <!-- FAQ 3 -->
                    <div class="accordion-item">
                        <h2 class="accordion-header" id="faq3">
                            <button class="accordion-button collapsed" type="button"
                                    data-bs-toggle="collapse" data-bs-target="#collapse3">
                                <i class="fas fa-desktop me-2"></i>
                                How many devices can I activate my license on?
                            </button>
                        </h2>
                        <div id="collapse3" class="accordion-collapse collapse" data-bs-parent="#faqAccordion">
                            <div class="accordion-body">
                                The number of allowed activations depends on your license type. This information
                                is shown in your license details. Most licenses allow 1-3 activations.
                            </div>
                        </div>
                    </div>

                    <!-- FAQ 4 -->
                    <div class="accordion-item">
                        <h2 class="accordion-header" id="faq4">
                            <button class="accordion-button collapsed" type="button"
                                    data-bs-toggle="collapse" data-bs-target="#collapse4">
                                <i class="fas fa-sync-alt me-2"></i>
                                What if I need to transfer my license to a new computer?
                            </button>
                        </h2>
                        <div id="collapse4" class="accordion-collapse collapse" data-bs-parent="#faqAccordion">
                            <div class="accordion-body">
                                You can deactivate your license on an old computer and activate it on a new one,
                                as long as you don't exceed the maximum number of activations. Contact support
                                if you need help with license transfers.
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Quick Validation Modal -->
<div class="modal fade" id="validationModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-shield-alt me-2"></i>
                    Quick License Validation
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="quickValidationForm">
                    <div class="form-floating mb-3">
                        <input type="text"
                               class="form-control"
                               id="validationKey"
                               placeholder="XXXX-XXXX-XXXX-XXXX"
                               pattern="[A-Z0-9]{4}-[A-Z0-9]{4}-[A-Z0-9]{4}-[A-Z0-9]{4}"
                               required autocomplete="off">
                        <label for="validationKey">License Key</label>
                    </div>
                    <div id="validationResult" class="d-none"></div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" onclick="validateLicense()">
                    <i class="fas fa-check me-2"></i>
                    Validate
                </button>
            </div>
        </div>
    </div>
</div>

<!-- JavaScript -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    // License search form handler
    document.getElementById('licenseSearchForm').addEventListener('submit', function(e) {
        e.preventDefault();
        const query = document.getElementById('searchQuery').value.trim();

        if (!query) {
            alert('Please enter a license key or email address');
            return;
        }

        searchLicenses(query);
    });
});

// Search for licenses
function searchLicenses(query) {
    const resultsContainer = document.getElementById('searchResults');
    resultsContainer.innerHTML = '<div class="text-center py-4"><i class="fas fa-spinner fa-spin fa-2x text-primary"></i><p class="mt-2">Searching...</p></div>';
    resultsContainer.classList.remove('d-none');

    // Simulate API call (replace with actual API endpoint)
    setTimeout(() => {
        // Mock results - replace with actual API call
        const isEmail = query.includes('@');
        const mockResults = generateMockResults(query, isEmail);
        displayResults(mockResults);
    }, 1000);
}

// Generate mock results for demonstration
function generateMockResults(query, isEmail) {
    if (isEmail) {
        return [
            {
                license_key: 'DEMO-1234-5678-ABCD',
                product_name: 'Example Software Pro',
                status: 'active',
                expires_at: null,
                activations_used: 1,
                max_activations: 3,
                download_available: true
            },
            {
                license_key: 'DEMO-9876-5432-EFGH',
                product_name: 'Example Plugin Suite',
                status: 'active',
                expires_at: '2025-12-31',
                activations_used: 2,
                max_activations: 2,
                download_available: true
            }
        ];
    } else {
        // Single license lookup
        return [
            {
                license_key: query.toUpperCase(),
                product_name: 'Example Software Pro',
                status: 'active',
                expires_at: null,
                activations_used: 1,
                max_activations: 3,
                download_available: true
            }
        ];
    }
}

// Display search results
function displayResults(results) {
    const resultsContainer = document.getElementById('searchResults');

    if (!results || results.length === 0) {
        resultsContainer.innerHTML = `
            <div class="card card-modern">
                <div class="card-body text-center py-5">
                    <i class="fas fa-search text-muted mb-3" style="font-size: 3rem;"></i>
                    <h5 class="text-muted">No Licenses Found</h5>
                    <p class="text-muted">We couldn't find any licenses matching your search.</p>
                    <a href="mailto:${<%= "'" + (ENV['SUPPORT_EMAIL'] || 'support@example.com') + "'" %>}" class="btn btn-outline-primary">
                        <i class="fas fa-envelope me-2"></i>Contact Support
                    </a>
                </div>
            </div>
        `;
        return;
    }

    let html = '<div class="card card-modern"><div class="card-header bg-success text-white"><h5 class="mb-0"><i class="fas fa-check-circle me-2"></i>Licenses Found</h5></div><div class="card-body p-0">';

    results.forEach((license, index) => {
        const statusClass = license.status === 'active' ? 'success' :
                           license.status === 'suspended' ? 'warning' : 'danger';
        const statusIcon = license.status === 'active' ? 'check-circle' :
                          license.status === 'suspended' ? 'pause-circle' : 'times-circle';

        html += `
            <div class="p-4 ${index > 0 ? 'border-top' : ''}">
                <div class="row align-items-center">
                    <div class="col-md-8">
                        <h6 class="fw-bold mb-2">${license.product_name}</h6>
                        <div class="d-flex align-items-center mb-2">
                            <code class="me-3">${license.license_key}</code>
                            <span class="badge bg-${statusClass}">
                                <i class="fas fa-${statusIcon} me-1"></i>${license.status.charAt(0).toUpperCase() + license.status.slice(1)}
                            </span>
                        </div>
                        <small class="text-muted">
                            Activations: ${license.activations_used}/${license.max_activations} •
                            ${license.expires_at ? 'Expires: ' + license.expires_at : 'Lifetime License'}
                        </small>
                    </div>
                    <div class="col-md-4 text-md-end">
                        <div class="btn-group-vertical btn-group-sm w-100">
                            ${license.download_available ?
                                `<button class="btn btn-primary" onclick="downloadSoftware('${license.license_key}')">
                                    <i class="fas fa-download me-2"></i>Download
                                </button>` : ''
                            }
                            <button class="btn btn-outline-secondary" onclick="copyToClipboard('${license.license_key}')">
                                <i class="fas fa-copy me-2"></i>Copy Key
                            </button>
                            <a href="/license/${license.license_key}" class="btn btn-outline-info">
                                <i class="fas fa-info-circle me-2"></i>Details
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        `;
    });

    html += '</div></div>';
    resultsContainer.innerHTML = html;
}

// Show validation modal
function showValidationModal() {
    const modal = new bootstrap.Modal(document.getElementById('validationModal'));
    modal.show();
}

// Validate license in modal
function validateLicense() {
    const key = document.getElementById('validationKey').value.trim();
    const resultDiv = document.getElementById('validationResult');

    if (!key) {
        alert('Please enter a license key');
        return;
    }

    resultDiv.innerHTML = '<div class="text-center"><i class="fas fa-spinner fa-spin"></i> Validating...</div>';
    resultDiv.classList.remove('d-none');

    // Simulate validation (replace with actual API call)
    setTimeout(() => {
        const isValid = key.includes('DEMO') || key.length >= 16;

        if (isValid) {
            resultDiv.innerHTML = `
                <div class="alert alert-success">
                    <i class="fas fa-check-circle me-2"></i>
                    <strong>Valid License</strong><br>
                    This license is active and ready to use.
                </div>
            `;
        } else {
            resultDiv.innerHTML = `
                <div class="alert alert-danger">
                    <i class="fas fa-times-circle me-2"></i>
                    <strong>Invalid License</strong><br>
                    This license key is not valid or has been revoked.
                </div>
            `;
        }
    }, 1000);
}

// Download software
function downloadSoftware(licenseKey) {
    // In a real implementation, this would redirect to a secure download URL
    window.open(`/download/${licenseKey}/software.zip`, '_blank');
}

// Copy to clipboard
function copyToClipboard(text) {
    navigator.clipboard.writeText(text).then(() => {
        // Show success message
        const alert = document.createElement('div');
        alert.className = 'alert alert-success position-fixed';
        alert.style.cssText = 'top: 20px; right: 20px; z-index: 9999;';
        alert.innerHTML = '<i class="fas fa-check me-2"></i>License key copied to clipboard!';
        document.body.appendChild(alert);

        setTimeout(() => alert.remove(), 3000);
    });
}
</script>
