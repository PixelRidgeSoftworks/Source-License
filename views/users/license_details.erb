<div class="container my-4">
  <!-- Header -->
  <div class="row mb-4">
    <div class="col">
      <div class="d-flex justify-content-between align-items-center">
        <div>
          <h2 class="mb-1">License Details</h2>
          <p class="text-muted mb-0"><%= h(@license.product.name) %></p>
        </div>
        <div>
          <a href="/licenses" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-left me-2"></i>
            Back to Licenses
          </a>
        </div>
      </div>
    </div>
  </div>

  <div class="row">
    <!-- License Information -->
    <div class="col-lg-8">
      <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
          <h5 class="mb-0">
            <i class="fas fa-certificate me-2"></i>
            License Information
          </h5>
          <% if @license.status == 'active' %>
            <span class="badge bg-success">Active</span>
          <% elsif @license.status == 'suspended' %>
            <span class="badge bg-warning">Suspended</span>
          <% elsif @license.status == 'expired' %>
            <span class="badge bg-danger">Expired</span>
          <% else %>
            <span class="badge bg-secondary"><%= @license.status.capitalize %></span>
          <% end %>
        </div>
        <div class="card-body">
          <div class="row">
            <div class="col-md-6">
              <div class="mb-3">
                <label class="form-label text-muted">Product Name</label>
                <div class="fw-bold"><%= h(@license.product.name) %></div>
              </div>
            </div>
            <div class="col-md-6">
              <div class="mb-3">
                <label class="form-label text-muted">Version</label>
                <div class="fw-bold"><%= h(@license.product.version || 'N/A') %></div>
              </div>
            </div>
          </div>

          <div class="row">
            <div class="col-md-12">
              <div class="mb-3">
                <label class="form-label text-muted">License Key</label>
                <div class="d-flex align-items-center">
                  <code class="bg-light px-3 py-2 rounded flex-grow-1 me-2"><%= h(@license.license_key) %></code>
                  <button class="btn btn-outline-secondary"
                          onclick="navigator.clipboard.writeText('<%= @license.license_key %>')"
                          title="Copy to clipboard">
                    <i class="fas fa-copy"></i>
                  </button>
                </div>
              </div>
            </div>
          </div>

          <div class="row">
            <div class="col-md-4">
              <div class="mb-3">
                <label class="form-label text-muted">License Type</label>
                <div class="fw-bold"><%= h(@license.license_type || 'Standard') %></div>
              </div>
            </div>
            <div class="col-md-4">
              <div class="mb-3">
                <label class="form-label text-muted">Max Activations</label>
                <div class="fw-bold"><%= @license.effective_max_activations %></div>
              </div>
            </div>
            <div class="col-md-4">
              <div class="mb-3">
                <label class="form-label text-muted">Activations Used</label>
                <div class="fw-bold">
                  <%= @license.activation_count %>
                  <% if @license.activation_count >= @license.effective_max_activations %>
                    <span class="badge bg-danger ms-2">Limit Reached</span>
                  <% end %>
                </div>
              </div>
            </div>
          </div>

          <div class="row">
            <div class="col-md-6">
              <div class="mb-3">
                <label class="form-label text-muted">Expires</label>
                <div class="fw-bold">
                  <% if @license.effective_expires_at %>
                    <%= @license.effective_expires_at.strftime('%B %d, %Y at %I:%M %p') %>
                    <% if @license.effective_expires_at < Time.now %>
                      <span class="badge bg-danger ms-2">Expired</span>
                    <% elsif @license.effective_expires_at < Time.now + 30*24*60*60 %>
                      <span class="badge bg-warning ms-2">Expires Soon</span>
                    <% end %>
                  <% else %>
                    <span class="text-success">Never (Lifetime License)</span>
                  <% end %>
                </div>
              </div>
            </div>
            <div class="col-md-6">
              <div class="mb-3">
                <label class="form-label text-muted">Downloads</label>
                <div class="fw-bold"><%= @license.download_count %></div>
              </div>
            </div>
          </div>

          <div class="row">
            <div class="col-md-6">
              <div class="mb-3">
                <label class="form-label text-muted">Created</label>
                <div class="fw-bold"><%= @license.created_at.strftime('%B %d, %Y at %I:%M %p') %></div>
              </div>
            </div>
            <div class="col-md-6">
              <div class="mb-3">
                <label class="form-label text-muted">Last Downloaded</label>
                <div class="fw-bold">
                  <%= @license.last_downloaded_at ? @license.last_downloaded_at.strftime('%B %d, %Y at %I:%M %p') : 'Never' %>
                </div>
              </div>
            </div>
          </div>

          <% if @license.product.description %>
          <div class="row">
            <div class="col-12">
              <div class="mb-3">
                <label class="form-label text-muted">Product Description</label>
                <div class="text-secondary"><%= h(@license.product.description) %></div>
              </div>
            </div>
          </div>
          <% end %>
        </div>
      </div>

      <!-- Download Section -->
      <% if @license.valid? && @license.product.download_file %>
      <div class="card mt-4">
        <div class="card-header">
          <h5 class="mb-0">
            <i class="fas fa-download me-2"></i>
            Download Software
          </h5>
        </div>
        <div class="card-body">
          <div class="row align-items-center">
            <div class="col-md-8">
              <h6 class="mb-1"><%= h(@license.product.name) %></h6>
              <div class="text-muted">
                <% if @license.product.file_size %>
                  File size: <%= @license.product.file_size %>
                <% end %>
                <% if @license.product.version %>
                  â€¢ Version <%= h(@license.product.version) %>
                <% end %>
              </div>
            </div>
            <div class="col-md-4 text-end">
              <a href="/secure-download/<%= @license.id %>/<%= @license.product.download_file %>"
                 class="btn btn-success">
                <i class="fas fa-download me-2"></i>
                Download
              </a>
            </div>
          </div>
        </div>
      </div>
      <% elsif @license.product.download_url %>
      <div class="card mt-4">
        <div class="card-header">
          <h5 class="mb-0">
            <i class="fas fa-external-link-alt me-2"></i>
            External Download
          </h5>
        </div>
        <div class="card-body">
          <div class="row align-items-center">
            <div class="col-md-8">
              <h6 class="mb-1"><%= h(@license.product.name) %></h6>
              <div class="text-muted">Download available from external source</div>
            </div>
            <div class="col-md-4 text-end">
              <a href="<%= @license.product.download_url %>"
                 class="btn btn-primary"
                 target="_blank">
                <i class="fas fa-external-link-alt me-2"></i>
                Download
              </a>
            </div>
          </div>
        </div>
      </div>
      <% end %>
    </div>

    <!-- Sidebar -->
    <div class="col-lg-4">
      <!-- Quick Actions -->
      <div class="card">
        <div class="card-header">
          <h6 class="mb-0">
            <i class="fas fa-bolt me-2"></i>
            Quick Actions
          </h6>
        </div>
        <div class="card-body">
          <div class="d-grid gap-2">
            <% if @license.valid? && @license.product.download_file %>
              <a href="/secure-download/<%= @license.id %>/<%= @license.product.download_file %>"
                 class="btn btn-success">
                <i class="fas fa-download me-2"></i>
                Download Software
              </a>
            <% end %>
            <button class="btn btn-outline-secondary"
                    onclick="navigator.clipboard.writeText('<%= @license.license_key %>')">
              <i class="fas fa-copy me-2"></i>
              Copy License Key
            </button>
            <a href="/validate-license" class="btn btn-outline-info">
              <i class="fas fa-shield-alt me-2"></i>
              Validate License
            </a>
          </div>
        </div>
      </div>

      <!-- Subscription Management -->
      <% if @license.subscription_based? && @license.subscription %>
      <div class="card mt-4">
        <div class="card-header">
          <h6 class="mb-0">
            <i class="fas fa-sync-alt me-2"></i>
            Subscription Management
          </h6>
        </div>
        <div class="card-body">
          <% subscription = @license.subscription %>
          
          <!-- Subscription Status -->
          <div class="mb-3">
            <label class="form-label text-muted">Subscription Status</label>
            <div>
              <% case subscription.status %>
              <% when 'active' %>
                <span class="badge bg-success">Active</span>
              <% when 'past_due' %>
                <span class="badge bg-warning">Past Due</span>
              <% when 'canceled' %>
                <span class="badge bg-danger">Canceled</span>
              <% when 'paused' %>
                <span class="badge bg-secondary">Paused</span>
              <% else %>
                <span class="badge bg-secondary"><%= subscription.status.capitalize %></span>
              <% end %>
              
              <% if subscription.auto_renew %>
                <span class="badge bg-info ms-1">Auto-Renew</span>
              <% end %>
            </div>
          </div>

          <!-- Billing Period -->
          <% if subscription.current_period_end %>
          <div class="mb-3">
            <label class="form-label text-muted">Current Billing Period</label>
            <div class="fw-bold">
              <%= subscription.current_period_start.strftime('%B %d, %Y') %> - 
              <%= subscription.current_period_end.strftime('%B %d, %Y') %>
              <% if subscription.current_period_end < Time.now + 7*24*60*60 %>
                <small class="text-warning d-block">Renews in <%= ((subscription.current_period_end - Time.now) / (24*60*60)).ceil %> days</small>
              <% end %>
            </div>
          </div>
          <% end %>

          <!-- Grace Period Warning -->
          <% if @license.in_grace_period? %>
          <div class="alert alert-warning">
            <i class="fas fa-exclamation-triangle me-2"></i>
            <strong>Payment Issue</strong><br>
            Your subscription payment failed. You have until <%= @license.grace_period_ends_at.strftime('%B %d, %Y') %> to resolve this issue.
          </div>
          <% end %>

          <!-- Subscription Actions -->
          <div class="d-grid gap-2 mt-3">
            <% if subscription.status == 'active' %>
              <!-- Pause Subscription -->
              <button class="btn btn-outline-warning" 
                      onclick="manageSubscription('pause', '<%= subscription.id %>')"
                      <% unless subscription.external_subscription_id %>disabled title="Cannot pause: No Stripe subscription found"<% end %>>
                <i class="fas fa-pause me-2"></i>
                Pause Subscription
              </button>
              
              <!-- Cancel Subscription -->
              <button class="btn btn-outline-danger" 
                      onclick="manageSubscription('cancel', '<%= subscription.id %>')"
                      <% unless subscription.external_subscription_id %>disabled title="Cannot cancel: No Stripe subscription found"<% end %>>
                <i class="fas fa-times me-2"></i>
                Cancel Subscription
              </button>

            <% elsif subscription.status == 'paused' %>
              <!-- Resume Subscription -->
              <button class="btn btn-outline-success" 
                      onclick="manageSubscription('resume', '<%= subscription.id %>')"
                      <% unless subscription.external_subscription_id %>disabled title="Cannot resume: No Stripe subscription found"<% end %>>
                <i class="fas fa-play me-2"></i>
                Resume Subscription
              </button>

            <% elsif subscription.status == 'past_due' %>
              <!-- Update Payment Method -->
              <a href="/update-payment-method/<%= subscription.id %>" class="btn btn-outline-primary">
                <i class="fas fa-credit-card me-2"></i>
                Update Payment Method
              </a>
              
            <% elsif subscription.status == 'canceled' %>
              <!-- Reactivate Option -->
              <div class="text-muted text-center">
                <p>This subscription has been canceled.</p>
                <a href="/reactivate-subscription/<%= subscription.id %>" class="btn btn-primary">
                  <i class="fas fa-redo me-2"></i>
                  Purchase New Subscription
                </a>
              </div>
            <% end %>
          </div>

          <!-- Stripe Customer Portal Link -->
          <% if subscription.external_subscription_id %>
          <hr>
          <div class="text-center">
            <a href="/customer-portal/<%= subscription.id %>" class="btn btn-outline-primary btn-sm">
              <i class="fab fa-stripe me-2"></i>
              Manage via Stripe
            </a>
          </div>
          <% end %>
        </div>
      </div>
      <% end %>

      <!-- License Status -->
      <div class="card mt-4">
        <div class="card-header">
          <h6 class="mb-0">
            <i class="fas fa-info-circle me-2"></i>
            License Status
          </h6>
        </div>
        <div class="card-body">
          <% if @license.valid? %>
            <div class="alert alert-success">
              <i class="fas fa-check-circle me-2"></i>
              <strong>Valid License</strong><br>
              This license is active and ready to use.
            </div>
          <% else %>
            <div class="alert alert-warning">
              <i class="fas fa-exclamation-triangle me-2"></i>
              <strong>License Issue</strong><br>
              <% if @license.status == 'suspended' %>
                This license has been suspended.
              <% elsif @license.status == 'expired' %>
                This license has expired.
              <% elsif @license.status == 'revoked' %>
                This license has been revoked.
              <% else %>
                This license is not currently active.
              <% end %>
            </div>
          <% end %>

          <% if @license.activation_count >= @license.effective_max_activations %>
            <div class="alert alert-warning">
              <i class="fas fa-exclamation-triangle me-2"></i>
              <strong>Activation Limit Reached</strong><br>
              You have used all available activations for this license.
            </div>
          <% end %>

          <% if @license.effective_expires_at && @license.effective_expires_at < Time.now + 30*24*60*60 %>
            <div class="alert alert-info">
              <i class="fas fa-clock me-2"></i>
              <strong>Expires Soon</strong><br>
              This license expires on <%= @license.effective_expires_at.strftime('%B %d, %Y') %>.
            </div>
          <% end %>
        </div>
      </div>

      <!-- Support -->
      <div class="card mt-4">
        <div class="card-body text-center">
          <h6 class="card-title">
            <i class="fas fa-life-ring me-2"></i>
            Need Help?
          </h6>
          <p class="card-text small text-muted">
            Contact our support team for assistance with your license.
          </p>
          <a href="mailto:<%= custom('branding.support_email', ENV['SUPPORT_EMAIL'] || 'support@example.com') %>"
             class="btn btn-outline-primary btn-sm">
            <i class="fas fa-envelope me-2"></i>
            Contact Support
          </a>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
function copyToClipboard(text) {
  navigator.clipboard.writeText(text).then(function() {
    // Could add a toast notification here
    console.log('License key copied to clipboard');
  });
}

function manageSubscription(action, subscriptionId) {
  if (!confirm(`Are you sure you want to ${action} this subscription? This action will be processed immediately.`)) {
    return;
  }

  const button = event.target;
  const originalText = button.innerHTML;
  button.disabled = true;
  button.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Processing...';

  fetch(`/subscription/${subscriptionId}/${action}`, {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
    },
    credentials: 'same-origin'
  })
  .then(response => response.json())
  .then(data => {
    if (data.success) {
      // Show success message
      showNotification('success', data.message || `Subscription ${action} successful!`);
      
      // Reload page after 2 seconds to show updated status
      setTimeout(() => {
        window.location.reload();
      }, 2000);
    } else {
      // Show error message
      showNotification('error', data.error || `Failed to ${action} subscription. Please try again.`);
      button.disabled = false;
      button.innerHTML = originalText;
    }
  })
  .catch(error => {
    console.error('Error:', error);
    showNotification('error', `Network error occurred. Please try again.`);
    button.disabled = false;
    button.innerHTML = originalText;
  });
}

function showNotification(type, message) {
  // Create notification element
  const notification = document.createElement('div');
  notification.className = `alert alert-${type === 'success' ? 'success' : 'danger'} alert-dismissible fade show position-fixed`;
  notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; max-width: 400px;';
  notification.innerHTML = `
    <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-circle'} me-2"></i>
    ${message}
    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
  `;
  
  document.body.appendChild(notification);
  
  // Auto-remove after 5 seconds
  setTimeout(() => {
    if (notification.parentNode) {
      notification.parentNode.removeChild(notification);
    }
  }, 5000);
}
</script>
